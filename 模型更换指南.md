# 绘本生成模型更换指南

本文档说明如何更换绘本生成时调用的图像生成模型。

---

## 📍 需要修改的文件和位置

### 1. **lib/qiniu.ts** - 主要模型配置（必须修改）

这是**最关键的修改位置**，实际使用的模型在这里配置。

#### 位置1：`submitQiniuImageTask` 函数中的模型配置
**文件**: `lib/qiniu.ts`  
**行号**: 第 219 行  
**当前配置**:
```typescript
model: 'gemini-2.5-flash-image',  // 使用正确的模型名称
```

**修改方法**:
```typescript
// 将 'gemini-2.5-flash-image' 替换为你想要使用的模型名称
model: 'your-new-model-name',  // 例如: 'kling-v1', 'stable-diffusion-xl', 等
```

#### 位置2：`verifyQiniuApiKey` 函数中的测试模型（可选）
**文件**: `lib/qiniu.ts`  
**行号**: 第 83 行  
**当前配置**:
```typescript
model: 'kling-v1',
```

**说明**: 这是用于验证API密钥的测试请求，建议与主模型保持一致，但也可以使用其他模型进行测试。

**修改方法**:
```typescript
model: 'your-new-model-name',  // 与主模型保持一致，或使用测试模型
```

#### 位置3：接口类型定义中的注释（可选，仅文档）
**文件**: `lib/qiniu.ts`  
**行号**: 第 6 行  
**当前配置**:
```typescript
model?: string;  // 模型ID，例如 'kling-v1'（兼容OpenAI格式，使用小写）
```

**说明**: 这只是类型定义和注释，不影响实际功能，但建议更新以保持代码一致性。

---

### 2. **lib/imageGenerator.ts** - 注释更新（可选）

**文件**: `lib/imageGenerator.ts`  
**行号**: 第 242 行  
**当前注释**:
```typescript
/**
 * 生成绘本页面图像
 * 使用七牛云文生图API（kling-v1模型）
 */
```

**修改方法**:
```typescript
/**
 * 生成绘本页面图像
 * 使用七牛云文生图API（your-new-model-name模型）
 */
```

**说明**: 这只是注释，不影响实际功能，但建议更新以保持文档准确性。

---

### 3. **lib/qiniu.ts** - 函数注释更新（可选）

**文件**: `lib/qiniu.ts`  
**行号**: 第 142 行和第 694 行  
**当前注释**:
```typescript
/**
 * 提交七牛云文生图任务（同步返回图片URL）
 * 根据七牛云API文档，使用gemini-2.5-flash-image模型，同步返回结果
 */
```

和

```typescript
/**
 * 生成图片（同步方式）
 * 根据七牛云API文档，使用gemini-2.5-flash-image模型，API同步返回结果
 */
```

**修改方法**: 更新注释中的模型名称。

---

### 4. **ENV_SETUP.md** - 文档更新（可选）

**文件**: `ENV_SETUP.md`  
**行号**: 第 58 行  
**当前内容**:
```markdown
- 模型ID：`kling-v1`
```

**修改方法**: 更新文档中的模型ID信息。

---

## 🔧 详细修改步骤

### 步骤1：确定新模型名称

首先，确认你要使用的模型名称。常见的七牛云模型包括：
- `gemini-2.5-flash-image` (当前使用)
- `kling-v1`
- `stable-diffusion-xl`
- 其他七牛云支持的模型

**注意**: 确保新模型支持你需要的功能（如同步返回、参数支持等）。

---

### 步骤2：修改核心代码（必须）

打开 `lib/qiniu.ts` 文件，找到第 219 行：

```typescript
// 修改前
const requestBody: any = {
  model: 'gemini-2.5-flash-image',  // 使用正确的模型名称
  prompt: finalPrompt,
};

// 修改后（示例：使用 kling-v1）
const requestBody: any = {
  model: 'kling-v1',  // 使用新的模型名称
  prompt: finalPrompt,
};
```

---

### 步骤3：检查模型参数兼容性（重要）

不同模型可能支持不同的参数。检查 `submitQiniuImageTask` 函数中的参数配置：

**当前参数**:
```typescript
{
  negative_prompt?: string;      // 负面提示词
  aspect_ratio?: string;         // 宽高比（如 '1:1', '16:9'）
  human_fidelity?: number;       // 真实度（0-1）
}
```

**注意**: 
- 如果新模型不支持某些参数（如 `aspect_ratio`、`human_fidelity`），需要：
  1. 移除不支持的参数
  2. 或添加条件判断，只在支持的模型上使用这些参数

**示例**（如果新模型不支持 `aspect_ratio`）:
```typescript
const requestBody: any = {
  model: 'your-new-model',
  prompt: finalPrompt,
  negative_prompt: options?.negative_prompt,
  // 不添加 aspect_ratio 和 human_fidelity
};
```

---

### 步骤4：更新调用参数（如需要）

如果新模型需要不同的参数，还需要修改 `lib/imageGenerator.ts` 中的调用：

**文件**: `lib/imageGenerator.ts`  
**行号**: 第 256-263 行

**当前调用**:
```typescript
const imageUrl = await generateImageWithQiniu(
  prompt,
  {
    negative_prompt: '恐怖，暴力，成人内容，低质量，模糊，变形',
    aspect_ratio: '1:1',
    human_fidelity: 0.8,
  }
);
```

**如果新模型不支持某些参数，需要移除**:
```typescript
const imageUrl = await generateImageWithQiniu(
  prompt,
  {
    negative_prompt: '恐怖，暴力，成人内容，低质量，模糊，变形',
    // 移除不支持的参数
  }
);
```

---

### 步骤5：更新验证函数（可选）

如果修改了主模型，建议同步更新 `verifyQiniuApiKey` 函数中的测试模型：

**文件**: `lib/qiniu.ts`  
**行号**: 第 83 行

```typescript
// 修改前
const testRequestBody = {
  model: 'kling-v1',
  prompt: 'test',
  // ...
};

// 修改后
const testRequestBody = {
  model: 'your-new-model-name',  // 与主模型保持一致
  prompt: 'test',
  // ...
};
```

---

### 步骤6：更新注释和文档（可选但推荐）

更新相关注释和文档，保持代码可读性：
1. `lib/qiniu.ts` 第 142 行和第 694 行的函数注释
2. `lib/imageGenerator.ts` 第 242 行的函数注释
3. `ENV_SETUP.md` 中的模型信息

---

## ⚠️ 注意事项

### 1. API兼容性
- 确保新模型支持同步返回（如果当前代码依赖同步返回）
- 检查新模型的API端点是否相同（当前使用 `/images/generations`）

### 2. 参数支持
- 不同模型支持的参数可能不同
- 如果新模型不支持某些参数，移除它们以避免API错误

### 3. 错误处理
- 更换模型后，建议进行充分测试
- 注意新模型可能返回不同的错误格式

### 4. 成本考虑
- 不同模型的计费方式可能不同
- 建议先测试少量请求，确认成本

### 5. 性能差异
- 不同模型的生成速度可能不同
- 如果新模型较慢，可能需要调整重试逻辑或超时时间

---

## 📝 修改检查清单

- [ ] 修改 `lib/qiniu.ts` 第 219 行的模型名称（必须）
- [ ] 检查新模型支持的参数，移除不支持的参数（如需要）
- [ ] 更新 `lib/imageGenerator.ts` 中的调用参数（如需要）
- [ ] 更新 `lib/qiniu.ts` 第 83 行的测试模型（可选）
- [ ] 更新相关注释（可选但推荐）
- [ ] 更新文档（可选）
- [ ] 测试新模型是否正常工作
- [ ] 检查错误处理和日志输出

---

## 🔍 快速定位

使用以下命令快速查找所有模型相关配置：

```bash
# 查找所有模型配置
grep -r "model.*:" lib/qiniu.ts
grep -r "模型" lib/*.ts
```

---

## 📚 相关文件清单

| 文件 | 行号 | 修改类型 | 优先级 |
|------|------|----------|--------|
| `lib/qiniu.ts` | 219 | 核心配置 | **必须** |
| `lib/qiniu.ts` | 83 | 测试模型 | 可选 |
| `lib/qiniu.ts` | 142, 694 | 注释 | 可选 |
| `lib/imageGenerator.ts` | 242 | 注释 | 可选 |
| `lib/imageGenerator.ts` | 256-263 | 调用参数 | 如需要 |
| `ENV_SETUP.md` | 58 | 文档 | 可选 |

---

## 💡 示例：切换到 kling-v1 模型

假设要切换到 `kling-v1` 模型：

### 1. 修改 `lib/qiniu.ts` 第 219 行：
```typescript
model: 'kling-v1',  // 替换 'gemini-2.5-flash-image'
```

### 2. 检查参数支持：
- `kling-v1` 通常支持 `aspect_ratio` 和 `human_fidelity`
- 如果支持，无需修改调用参数

### 3. 更新注释（可选）：
```typescript
/**
 * 提交七牛云文生图任务（同步返回图片URL）
 * 根据七牛云API文档，使用kling-v1模型，同步返回结果
 */
```

---

*最后更新: 2024年*
